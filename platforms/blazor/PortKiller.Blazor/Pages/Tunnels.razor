@page "/tunnels"
@using PortKiller.Blazor.Services
@using PortKiller.Blazor.Models
@using Microsoft.Extensions.Logging
@using System.Threading.Tasks
@inject TunnelService TunnelService
@inject NavigationManager Navigation
@inject ThemeService ThemeService
@inject ILogger<Tunnels> Logger
@inject NotificationService NotificationService
@inject IJSRuntime JSRuntime

<PageTitle>隧道管理</PageTitle>

<NavigationMenu />

<MContainer Class="pt-2">
    <MRow Dense>
        <MCol Cols="12" Class="text-center">
            <h2 class="text-h4 font-weight-bold">隧道管理</h2>
            <p class="text-body2 text--secondary">管理Cloudflare隧道</p>
        </MCol>
    </MRow>

    @if (_showNotification)
    {
        <MSnackbar Value="_showNotification" ValueChanged="@(v => _showNotification = v)" Color="@_notificationType" Timeout="3000">
            <MIcon Class="mr-2">@_notificationIcon</MIcon>
            @_notificationMessage
        </MSnackbar>
    }

    <MRow Class="mb-3" Dense>
        <MCol Cols="12">
            <MCard Elevation="0" Outlined Class="pa-2">
                <div class="d-flex flex-wrap align-center gap-2">
                    <div class="d-flex align-center gap-2">
                        <MIcon Small Color="primary">mdi-cloud</MIcon>
                        <span class="text-body2 font-weight-medium">Cloudflared</span>
                        @if (_cloudflaredStatus == null)
                        {
                            <MProgressCircular Indeterminate Size="16" />
                            <span class="text-caption">检查中...</span>
                        }
                        else if (_cloudflaredStatus.IsInstalled)
                        {
                            <MChip Small Color="success" Outlined>
                                <MIcon XSmall Left>mdi-check-circle</MIcon>
                                @_cloudflaredStatus.Version
                            </MChip>
                            @if (_isUpdatingCloudflared && _updateProgress != null)
                            {
                                <MProgressLinear Value="@_updateProgress.Progress" Style="width: 100px;" />
                            }
                            else if (_cloudflaredStatus.HasUpdate)
                            {
                                <MChip Small Color="warning" Outlined>
                                    <MIcon XSmall Left>mdi-arrow-up-bold</MIcon>
                                    新版本 @_cloudflaredStatus.LatestVersion
                                </MChip>
                                <MButton Color="warning" OnClick="@UpdateCloudflared" Disabled="@_isUpdatingCloudflared" Outlined>
                                    <MIcon Small Left>mdi-download</MIcon>
                                    升级
                                </MButton>
                            }
                            else
                            {
                                <MChip Small Color="info" Outlined>
                                    <MIcon XSmall Left>mdi-check</MIcon>
                                    已是最新
                                </MChip>
                            }
                        }
                        else
                        {
                            <MChip Small Color="error" Outlined>
                                <MIcon XSmall Left>mdi-close-circle</MIcon>
                                未安装
                            </MChip>
                        }
                    </div>
                    <MSpacer></MSpacer>
                    <MButton Color="primary" OnClick="@RefreshTunnels" Outlined>
                        <MIcon Small Left>mdi-refresh</MIcon>
                        刷新
                    </MButton>
                    @if (_tunnels.Count > 0)
                    {
                        <MButton Color="error" OnClick="@StopAllTunnels" Outlined>
                            <MIcon Small Left>mdi-delete</MIcon>
                            全部删除
                        </MButton>
                    }
                </div>
            </MCard>
        </MCol>
    </MRow>

    @if (_tunnels.Count > 0)
    {
        <MRow class="mb-4" Dense>
            <MCol cols="6" sm="3" md="3">
                <MCard Elevation="1" Class="h-100 transition-swing" Hover>
                    <MCardText Class="pa-3 text-center">
                        <div class="d-flex align-center justify-center rounded-circle mx-auto mb-2" style="width: 48px; height: 48px; background: var(--m-primary-color-4);">
                            <MIcon Small Color="primary">mdi-chart-bar</MIcon>
                        </div>
                        <p class="text-caption text--secondary mb-1">隧道总数</p>
                        <p class="text-h5 font-weight-bold mb-0">@_tunnels.Count</p>
                    </MCardText>
                </MCard>
            </MCol>
            <MCol cols="6" sm="3" md="3">
                <MCard Elevation="1" Class="h-100 transition-swing" Hover>
                    <MCardText Class="pa-3 text-center">
                        <div class="d-flex align-center justify-center rounded-circle mx-auto mb-2" style="width: 48px; height: 48px; background: var(--m-success-color-4);">
                            <MIcon Small Color="success">mdi-check-circle</MIcon>
                        </div>
                        <p class="text-caption text--secondary mb-1">活动隧道</p>
                        <p class="text-h5 font-weight-bold mb-0">@_tunnels.Count(t => t.IsActive)</p>
                    </MCardText>
                </MCard>
            </MCol>
            <MCol cols="6" sm="3" md="3">
                <MCard Elevation="1" Class="h-100 transition-swing" Hover>
                    <MCardText Class="pa-3 text-center">
                        <div class="d-flex align-center justify-center rounded-circle mx-auto mb-2" style="width: 48px; height: 48px; background: var(--m-warning-color-4);">
                            <MIcon Small Color="warning">mdi-clock-outline</MIcon>
                        </div>
                        <p class="text-caption text--secondary mb-1">未知</p>
                        <p class="text-h5 font-weight-bold mb-0">@_tunnels.Count(t => t.Status == "Active" && t.TunnelUrl == "Unknown")</p>
                    </MCardText>
                </MCard>
            </MCol>
            <MCol cols="6" sm="3" md="3">
                <MCard Elevation="1" Class="h-100 transition-swing" Hover>
                    <MCardText Class="pa-3 text-center">
                        <div class="d-flex align-center justify-center rounded-circle mx-auto mb-2" style="width: 48px; height: 48px; background: var(--m-error-color-4);">
                            <MIcon Small Color="error">mdi-close-circle</MIcon>
                        </div>
                        <p class="text-caption text--secondary mb-1">停止中</p>
                        <p class="text-h5 font-weight-bold mb-0">@_tunnels.Count(t => t.Status == "Stopping")</p>
                    </MCardText>
                </MCard>
            </MCol>
        </MRow>
    }

    @if (_tunnels.Count == 0)
    {
        <MRow class="justify-center mb-4" Dense>
            <MCol cols="12" sm="8" md="6" Class="text-center">
                <MCard Elevation="1" Class="pa-6 transition-swing" Hover>
                    <div class="d-flex flex-column align-center">
                        <div class="d-flex align-center justify-center rounded-circle mb-3" style="width: 64px; height: 64px; background: var(--m-surface-variant-color);">
                            <MIcon Size="32" Color="grey">mdi-earth-off</MIcon>
                        </div>
                        <p class="text-h6 font-weight-medium mb-1">无活动隧道</p>
                        <p class="text-body2 text--secondary mb-0">创建一个隧道来暴露本地端口</p>
                    </div>
                </MCard>
            </MCol>
        </MRow>
    }
    else
    {
        <MRow class="mb-4" Dense>
            @foreach (var tunnel in _tunnels)
            {
                <MCol cols="12" sm="6" md="4" lg="2">
                    <MHover>
                        @{
                            var tunnelCardClass = "tunnel-card" + (context.Hover ? " tunnel-card-hover" : "") + " h-100 d-flex flex-column transition-swing";
                        }
                        <MCard @attributes="context.Attrs" Elevation="@(context.Hover ? 12 : 1)" Class="@tunnelCardClass">
                            <MCardText Class="pa-3 flex-grow-1">
                            <div class="d-flex justify-space-between align-center mb-3">
                                <div class="d-flex align-center">
                                    <div class="d-flex align-center justify-center rounded port-number-box mr-2">
                                        <span class="text-subtitle-2 font-weight-bold port-number-text" style="color: var(--m-primary-color);">@tunnel.Port</span>
                                    </div>
                                    <MChip XSmall Color="@(tunnel.IsActive ? "success" : "error")" Outlined>
                                        <MIcon XXSmall Left>mdi-circle</MIcon>
                                        @(tunnel.IsActive ? "活动" : "停止")
                                    </MChip>
                                </div>
                            </div>
                            <div class="mb-3 pa-2 rounded" style="background: var(--m-surface-variant-color);">
                                <div class="d-flex align-center gap-1">
                                    <MIcon XSmall Color="primary">mdi-link</MIcon>
                                    <a href="@tunnel.TunnelUrl" target="_blank" class="text-caption text-primary text-truncate flex-grow-1">@tunnel.TunnelUrl</a>
                                    <MButton Icon XSmall Color="primary" OnClick="@(() => CopyToClipboard(tunnel.TunnelUrl))" Title="复制">
                                        <MIcon XSmall>mdi-content-copy</MIcon>
                                    </MButton>
                                </div>
                            </div>
                            <div class="d-flex align-center gap-2 mb-2">
                                <MIcon XSmall Color="grey">mdi-clock-outline</MIcon>
                                <span class="text-caption text--secondary">运行时间: @tunnel.Uptime</span>
                            </div>
                            <div class="d-flex align-center gap-2">
                                <MIcon XSmall Color="grey">mdi-identifier</MIcon>
                                <span class="text-caption text--secondary">进程 ID: @tunnel.ProcessId</span>
                            </div>
                            @if (!string.IsNullOrEmpty(tunnel.LastError))
                            {
                                <MAlert Type="@AlertTypes.Error" Dense Class="mt-2 mb-0" Outlined>
                                    <MIcon XSmall Left>mdi-alert</MIcon>
                                    <span class="text-caption">@tunnel.LastError</span>
                                </MAlert>
                            }
                        </MCardText>
                        <MCardActions Class="justify-center pa-2" Style="background: var(--m-surface-variant-color); border-top: 1px solid var(--m-border-color);">
                            <MButton Icon Small Color="warning" OnClick="@(() => RestartTunnel(tunnel.Port))" Title="重新创建隧道">
                                <MIcon Small>mdi-refresh</MIcon>
                            </MButton>
                            <MButton Icon Small Color="error" OnClick="@(() => StopTunnel(tunnel.Port))" Title="停止隧道">
                                <MIcon Small>mdi-close</MIcon>
                            </MButton>
                        </MCardActions>
                    </MCard>
                    </MHover>
                </MCol>
            }
        </MRow>
    }

    <MRow Dense>
        <MCol cols="12" sm="6" md="4">
            <MCard Elevation="2" Class="transition-swing" Hover>
                <MCardTitle Class="py-3 px-4 d-flex align-center" Style="background: var(--m-success-color); color: white;">
                    <div class="d-flex align-center justify-center rounded-circle mr-3" style="width: 32px; height: 32px; background: rgba(255,255,255,0.2);">
                        <MIcon Small Color="white">mdi-plus</MIcon>
                    </div>
                    <span class="text-h6 font-weight-medium">创建新隧道</span>
                </MCardTitle>
                <MCardText Class="pa-4">
                    <MForm>
                        <MTextField
                            Label="端口号"
                            Type="number"
                            @bind-Value="_newTunnelPort"
                            Placeholder="输入要暴露的端口号"
                            Dense
                            HideDetails="true"
                            Class="mb-3"
                            PrependInnerIcon="mdi-numeric"
                            Outlined
                        />
                        <MTextField
                            Label="隧道名称 (可选)"
                            @bind-Value="_newTunnelName"
                            Placeholder="输入隧道名称"
                            Dense
                            HideDetails="true"
                            Class="mb-3"
                            PrependInnerIcon="mdi-tag"
                            Outlined
                        />
                        @if (_isCreatingTunnel)
                        {
                            <MButton Color="success" Disabled="true" Block Class="mt-2">
                                <MProgressCircular Indeterminate Size="16" Class="mr-2" />
                                创建中...
                            </MButton>
                        }
                        else
                        {
                            <MButton Color="success" OnClick="@CreateTunnel" Block Class="mt-2">
                                <MIcon Small Left>mdi-earth-plus</MIcon>
                                创建隧道
                            </MButton>
                        }
                    </MForm>
                </MCardText>
            </MCard>
        </MCol>
    </MRow>

    @if (_showTunnelInfoBox)
    {
        <MRow class="mt-4" Dense>
            <MCol cols="12">
                <MAlert Type="@AlertTypes.Info" Dense Dismissible @bind-Value="_showTunnelInfoBox">
                    <div class="d-flex align-start gap-2">
                        <MIcon Small>mdi-lightbulb</MIcon>
                        <div>
                            <span class="text-body-2 font-weight-bold">一键发布至公网</span>
                            <span class="text-caption d-block">鼠标一点，即可将内网站点发布至公网，方便给客户演示、远程调试和协同开发</span>
                        </div>
                    </div>
                </MAlert>
            </MCol>
        </MRow>
    }
</MContainer>

@code {
    private List<CloudflareTunnel> _tunnels = new();
    private CloudflaredStatus? _cloudflaredStatus;
    private int _newTunnelPort;
    private string _newTunnelName = string.Empty;
    private bool _isCreatingTunnel = false;
    private bool _isUpdatingCloudflared = false;
    private CloudflaredUpdateProgress? _updateProgress;
    private bool _showNotification = false;
    private string _notificationMessage = string.Empty;
    private string _notificationType = string.Empty;
    private string _notificationIcon = string.Empty;
    private bool _showTunnelInfoBox = true;
    private System.Threading.Timer? _tunnelTimer;
    private bool _isInitialized = false;

    protected override async Task OnInitializedAsync()
    {
        _isInitialized = true;
        _tunnelTimer = new System.Threading.Timer(_ => UpdateTunnelStatus(), null, TimeSpan.FromSeconds(1), TimeSpan.FromSeconds(5));
        
        _ = Task.Run(async () => 
        {
            await TunnelService.InitializeAsync();
            await LoadTunnelsAsync();
            await InvokeAsync(() => StateHasChanged());
        });
        
        _ = Task.Run(async () => 
        {
            await ScanTunnelsAsync();
            await InvokeAsync(() => StateHasChanged());
        });
        
        _ = Task.Run(async () => 
        {
            await CheckCloudflaredStatus();
            await InvokeAsync(() => StateHasChanged());
        });
    }

    public void Dispose()
    {
        _tunnelTimer?.Dispose();
    }

    private async Task LoadTunnelsAsync()
    {
        try
        {
            _tunnels = TunnelService.GetTunnels();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading tunnels");
            ShowNotification("加载隧道失败", "error");
        }
    }

    private async Task RefreshTunnels()
    {
        try
        {
            _tunnels = TunnelService.GetTunnels();
            ShowNotification("隧道已刷新", "success");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error refreshing tunnels");
            ShowNotification("刷新隧道失败", "error");
        }
    }

    private async Task ScanTunnelsAsync()
    {
        try
        {
            var scannedTunnels = await TunnelService.ScanTunnelsAsync();
            if (scannedTunnels.Count > 0)
            {
                _tunnels = TunnelService.GetTunnels();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error scanning tunnels");
        }
    }

    private async Task CreateTunnel()
    {
        if (string.IsNullOrWhiteSpace(_newTunnelPort.ToString()) || _newTunnelPort <= 0)
        {
            ShowNotification("请输入有效的端口号", "warning");
            return;
        }

        _isCreatingTunnel = true;
        StateHasChanged();

        try
        {
            var tunnel = await TunnelService.CreateTunnelAsync(_newTunnelPort, _newTunnelName);
            _tunnels = TunnelService.GetTunnels();
            ShowNotification($"隧道已创建: {tunnel.TunnelUrl}", "success");
            _newTunnelPort = 0;
            _newTunnelName = string.Empty;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error creating tunnel");
            ShowNotification($"创建隧道失败: {ex.Message}", "error");
        }
        finally
        {
            _isCreatingTunnel = false;
            StateHasChanged();
        }
    }

    private async Task StopTunnel(int port)
    {
        try
        {
            TunnelService.StopTunnel(port);
            _tunnels = TunnelService.GetTunnels();
            ShowNotification($"端口 {port} 的隧道已停止", "success");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error stopping tunnel");
            ShowNotification($"停止隧道失败: {ex.Message}", "error");
        }
    }

    private async Task RestartTunnel(int port)
    {
        try
        {
            var tunnel = await TunnelService.RestartTunnelAsync(port);
            _tunnels = TunnelService.GetTunnels();
            ShowNotification($"端口 {port} 的隧道已重启", "success");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error restarting tunnel");
            ShowNotification($"重启隧道失败: {ex.Message}", "error");
        }
    }

    private async Task StopAllTunnels()
    {
        try
        {
            TunnelService.StopAllTunnels();
            _tunnels.Clear();
            ShowNotification("所有隧道已停止", "success");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error stopping all tunnels");
            ShowNotification($"停止所有隧道失败: {ex.Message}", "error");
        }
    }

    private async Task CheckCloudflaredStatus()
    {
        try
        {
            _cloudflaredStatus = await TunnelService.GetCloudflaredStatusWithUpdateCheckAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error checking cloudflared status");
        }
    }

    private async Task UpdateCloudflared()
    {
        _isUpdatingCloudflared = true;
        StateHasChanged();

        try
        {
            var newVersion = await TunnelService.UpdateCloudflaredAsync();
            _cloudflaredStatus = null;
            await CheckCloudflaredStatus();
            ShowNotification($"Cloudflared 已升级到 {newVersion}", "success");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating cloudflared");
            ShowNotification($"升级失败: {ex.Message}", "error");
        }
        finally
        {
            _isUpdatingCloudflared = false;
            StateHasChanged();
        }
    }

    private void UpdateTunnelStatus()
    {
        if (!_isInitialized) return;
        
        try
        {
            TunnelService.UpdateTunnelStatus();
            _tunnels = TunnelService.GetTunnels();
            _ = InvokeAsync(() => StateHasChanged());
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating tunnel status");
        }
    }

    private async Task CopyToClipboard(string text)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", text);
            ShowNotification("已复制到剪贴板", "success");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error copying to clipboard");
            ShowNotification("复制失败", "error");
        }
    }

    private void ShowNotification(string message, string type = "success")
    {
        _notificationMessage = message;
        _notificationType = type;
        _notificationIcon = type switch
        {
            "success" => "✓",
            "error" => "✕",
            "warning" => "⚠",
            "info" => "ℹ",
            _ => "ℹ"
        };
        _showNotification = true;
        StateHasChanged();
    }

    private void HideNotification()
    {
        _showNotification = false;
        StateHasChanged();
    }

    private void HideTunnelInfoBox()
    {
        _showTunnelInfoBox = false;
        StateHasChanged();
    }



    private void GoToHome()
    {
        Navigation.NavigateTo("/");
    }

    private void GoToPorts()
    {
        Navigation.NavigateTo("/ports");
    }

    private void GoToTunnels()
    {
        Navigation.NavigateTo("/tunnels");
    }

    private void GoToAbout()
    {
        Navigation.NavigateTo("/about");
    }
}
